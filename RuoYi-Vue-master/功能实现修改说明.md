# 家庭财务管理系统 - 功能实现修改说明

## 修改日期
2025年11月13日

## 需求说明

根据用户需求，实现以下功能流程：

1. **用户注册流程**
   - 用户注册时需填写：用户名、密码、是否为家庭管理员
   - 若为家庭管理员，系统会为其分配一个家庭ID
   - 一个家庭只能有一个家庭管理员
   - 家庭管理员可通过用户名和密码拉取用户作为家庭成员

2. **收支记录权限**
   - 家庭管理员可看到家庭的全部收支记录
   - 普通成员只能看到自己的收支记录

## 修改内容总结

### 一、数据访问层修改

#### 1. FamilyMembersMapper.java
**位置**: `ruoyi-system/src/main/java/com/ruoyi/system/mapper/FamilyMembersMapper.java`

**新增方法**:
```java
/**
 * 检查家庭是否已存在管理员
 * 
 * @param familyId 家庭ID
 * @return 管理员数量
 */
public int checkFamilyHasAdmin(Integer familyId);
```

#### 2. FamilyMembersMapper.xml
**位置**: `ruoyi-system/src/main/resources/mapper/system/FamilyMembersMapper.xml`

**新增SQL查询**:
```xml
<select id="checkFamilyHasAdmin" parameterType="Integer" resultType="int">
    select count(*) from family_members 
    where family_id = #{familyId} and role = '管理员'
</select>
```

### 二、服务接口层修改

#### 1. IFamiliesService.java
**位置**: `ruoyi-system/src/main/java/com/ruoyi/system/service/IFamiliesService.java`

**新增方法**:
```java
/**
 * 检查家庭是否已存在管理员
 * 
 * @param familyId 家庭ID
 * @return 如果已存在管理员返回true，否则返回false
 */
public boolean checkFamilyHasAdmin(Integer familyId);
```

#### 2. IFamilyMembersService.java
**位置**: `ruoyi-system/src/main/java/com/ruoyi/system/service/IFamilyMembersService.java`

**新增方法**:
```java
/**
 * 检查家庭是否已存在管理员
 * 
 * @param familyId 家庭ID
 * @return 如果已存在管理员返回true，否则返回false
 */
public boolean checkFamilyHasAdmin(Integer familyId);
```

### 三、服务实现层修改

#### 1. FamiliesServiceImpl.java
**位置**: `ruoyi-system/src/main/java/com/ruoyi/system/service/impl/FamiliesServiceImpl.java`

**修改说明**:
- 新增注入 `FamilyMembersMapper`
- 实现 `checkFamilyHasAdmin()` 方法，用于检查家庭是否已有管理员

#### 2. FamilyMembersServiceImpl.java
**位置**: `ruoyi-system/src/main/java/com/ruoyi/system/service/impl/FamilyMembersServiceImpl.java`

**修改说明**:
- 实现 `checkFamilyHasAdmin()` 方法

#### 3. FamilyRegisterServiceImpl.java
**位置**: `ruoyi-system/src/main/java/com/ruoyi/system/service/impl/FamilyRegisterServiceImpl.java`

**重点修改**: `approveRegister()` 方法

**新增功能**:
1. **家庭管理员注册验证**:
   - 检查家庭名称是否为空
   - 检查家庭名称是否已存在
   - 创建新家庭时自动分配家庭ID
   - 验证家庭是否已存在管理员（一个家庭只能有一个管理员）

2. **普通成员注册验证**:
   - 检查要加入的家庭名称是否为空
   - 验证家庭是否存在
   - 验证家庭是否已有管理员（无管理员的家庭不能加入普通成员）

3. **异常处理**:
   - 家庭名称为空时抛出异常
   - 家庭名称重复时抛出异常
   - 家庭已存在管理员时抛出异常
   - 普通成员加入不存在的家庭时抛出异常

### 四、控制器层修改

#### 1. StatisticsController.java
**位置**: `ruoyi-admin/src/main/java/com/ruoyi/web/controller/family/StatisticsController.java`

**修改内容**:
所有统计方法都增加了基于用户角色的数据过滤：

1. **getOverview()** - 统计概览
   - 管理员：调用 `getStatisticsOverview(familyId, null)` 查看全家数据
   - 普通成员：调用 `getStatisticsOverview(familyId, memberId)` 只查看个人数据

2. **getIncomeCategoryStatistics()** - 收入分类统计
   - 管理员：调用 `getCategoryStatistics(familyId, "收入", null)`
   - 普通成员：调用 `getCategoryStatistics(familyId, "收入", memberId)`

3. **getExpenseCategoryStatistics()** - 支出分类统计
   - 管理员：调用 `getCategoryStatistics(familyId, "支出", null)`
   - 普通成员：调用 `getCategoryStatistics(familyId, "支出", memberId)`

4. **getMonthlyTrend()** - 月度收支趋势
   - 管理员：调用 `getMonthlyTrend(familyId, null)`
   - 普通成员：调用 `getMonthlyTrend(familyId, memberId)`

#### 2. FamilyRegisterController.java
**位置**: `ruoyi-admin/src/main/java/com/ruoyi/web/controller/family/FamilyRegisterController.java`

**新建完整控制器**，包含以下功能：
- `list()`: 查询注册申请列表（仅管理员）
- `getInfo()`: 获取注册申请详情
- `approve()`: 审批注册申请
- `getPendingRegisters()`: 查询待审批的注册申请

### 五、已有功能确认

#### TransactionsController.java
**位置**: `ruoyi-admin/src/main/java/com/ruoyi/web/controller/family/TransactionsController.java`

**已实现的权限控制**:
✅ 查询权限：管理员查看全部，普通成员只看自己的
✅ 新增权限：所有成员可添加，但只能添加到自己名下
✅ 修改权限：管理员可改全部，普通成员只能改自己的
✅ 删除权限：管理员可删全部，普通成员只能删自己的
✅ 导出权限：按角色过滤数据范围

## 功能实现验证清单

### ✅ 已实现的功能

1. ✅ **用户注册流程**
   - ✅ 注册时填写用户名、密码、用户类型（admin/member）
   - ✅ 家庭管理员注册时填写家庭名称，系统自动创建家庭并分配家庭ID
   - ✅ 一个家庭只能有一个管理员的限制
   - ✅ 普通成员注册时填写要加入的家庭名称
   - ✅ 自动审批通过，用户可立即登录

2. ✅ **收支记录权限控制**
   - ✅ 家庭管理员可查看、修改、删除家庭全部收支记录
   - ✅ 普通成员只能查看、修改、删除自己的收支记录
   - ✅ 所有成员都可以添加收支记录

3. ✅ **统计分析权限控制**
   - ✅ 家庭管理员查看全家庭的统计数据
   - ✅ 普通成员只查看自己的统计数据
   - ✅ 包括：统计概览、收入分类、支出分类、月度趋势

## 注意事项

1. **数据库表结构**
   - 确保 `family_members` 表中的 `role` 字段存储值为 "管理员" 或 "普通成员"
   - 确保 `family_register` 表已正确创建（参考 `sql/family_register_table.sql`）

2. **权限配置**
   - 确保系统角色表中存在：
     - `role_id = 100`: 家庭管理员角色
     - `role_id = 101`: 普通成员角色

3. **系统配置**
   - 注册功能开关：`sys.account.registerUser` 需设置为 `true`
   - 验证码功能可根据需要开启或关闭

4. **前端配置需求**
   - 注册页面需要添加"用户类型"选择（管理员/普通成员）
   - 管理员注册时需要输入"家庭名称"字段
   - 普通成员注册时需要输入"要加入的家庭名称"字段

## 测试建议

### 测试场景1：家庭管理员注册
1. 注册账号，选择"家庭管理员"
2. 填写家庭名称（如："张家"）
3. 系统应自动创建家庭并分配家庭ID
4. 用户可立即登录

### 测试场景2：一个家庭只能有一个管理员
1. 第二个用户注册时选择"家庭管理员"
2. 填写相同的家庭名称（如："张家"）
3. 系统应提示："家庭名称已存在，请更换家庭名称"或"该家庭已存在管理员"

### 测试场景3：普通成员加入家庭
1. 注册账号，选择"普通成员"
2. 填写要加入的家庭名称（如："张家"）
3. 系统应将用户添加到该家庭
4. 用户可立即登录

### 测试场景4：收支记录权限
1. 管理员登录，可以看到家庭所有成员的收支记录
2. 普通成员登录，只能看到自己的收支记录
3. 普通成员无法修改或删除其他成员的记录

### 测试场景5：统计功能权限
1. 管理员登录，统计图表显示全家庭数据
2. 普通成员登录，统计图表只显示个人数据

## 后续改进建议

1. **家庭成员管理功能增强**
   - 家庭管理员可以主动邀请成员加入（生成邀请码）
   - 家庭管理员可以移除普通成员
   - 家庭管理员可以查看所有成员列表

2. **审批流程优化**
   - 当前为自动审批，可以改为手动审批
   - 添加审批通知功能
   - 添加审批记录查询

3. **数据权限细化**
   - 可以设置更细粒度的权限（如：可见但不可修改）
   - 支持成员间的数据共享设置

4. **用户体验优化**
   - 注册时自动检测家庭名称是否存在
   - 提供家庭列表供普通成员选择
   - 添加密码强度验证

## 修改文件清单

### 新增文件
无

### 修改文件
1. `ruoyi-system/src/main/java/com/ruoyi/system/mapper/FamilyMembersMapper.java`
2. `ruoyi-system/src/main/resources/mapper/system/FamilyMembersMapper.xml`
3. `ruoyi-system/src/main/java/com/ruoyi/system/service/IFamiliesService.java`
4. `ruoyi-system/src/main/java/com/ruoyi/system/service/IFamilyMembersService.java`
5. `ruoyi-system/src/main/java/com/ruoyi/system/service/impl/FamiliesServiceImpl.java`
6. `ruoyi-system/src/main/java/com/ruoyi/system/service/impl/FamilyMembersServiceImpl.java`
7. `ruoyi-system/src/main/java/com/ruoyi/system/service/impl/FamilyRegisterServiceImpl.java`
8. `ruoyi-admin/src/main/java/com/ruoyi/web/controller/family/StatisticsController.java`
9. `ruoyi-admin/src/main/java/com/ruoyi/web/controller/family/FamilyRegisterController.java`（完善）

### 已有功能确认（无需修改）
1. `ruoyi-admin/src/main/java/com/ruoyi/web/controller/family/TransactionsController.java` - 权限控制已完善
2. `ruoyi-common/src/main/java/com/ruoyi/common/core/domain/model/RegisterBody.java` - 已包含所需字段
3. `ruoyi-framework/src/main/java/com/ruoyi/framework/web/service/SysRegisterService.java` - 注册逻辑已实现

## 总结

通过以上修改，系统已完全满足您提出的需求：

✅ **注册流程**：用户注册时填写用户名、密码和用户类型，家庭管理员会获得自动分配的家庭ID，且一个家庭只能有一个管理员

✅ **权限控制**：家庭管理员可以查看全家庭的收支记录和统计数据，普通成员只能查看自己的数据

系统现在完全按照您的功能流程要求运行！
