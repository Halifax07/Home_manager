# 家庭成员权限功能实现总结

## 功能概述

实现了家庭财务管理系统中普通成员与家庭管理员的权限区分功能：

1. **注册流程**: 用户注册时先进入待审批表，由家庭管理员审批后加入家庭
2. **数据权限**: 普通成员只能增删查改自己的收支记录
3. **统计分析**: 普通成员在统计分析时只能查看自己的数据产生的图表

## 主要修改内容

### 1. 数据库层面

#### 新增注册审批表
- **表名**: `family_register`
- **用途**: 存储用户注册申请，等待家庭管理员审批
- **字段**: 
  - `id`: 主键
  - `account`: 账号
  - `password_hash`: 密码哈希
  - `name`: 姓名
  - `gender`: 性别
  - `kinship`: 与户主关系
  - `occupation`: 职业
  - `user_type`: 用户类型(admin/member)
  - `family_name`: 家庭名称(管理员填写)
  - `status`: 状态(0=待审批,1=已通过,2=已拒绝)
  - `create_time`: 创建时间
  - `update_time`: 更新时间

### 2. 实体类和服务层

#### 新增文件
1. **FamilyRegister.java**: 注册申请实体类
2. **IFamilyRegisterService.java**: 注册服务接口
3. **FamilyRegisterServiceImpl.java**: 注册服务实现类
4. **FamilyRegisterMapper.java**: 注册数据访问接口
5. **FamilyRegisterMapper.xml**: 注册SQL映射文件
6. **FamilyRegisterController.java**: 注册管理控制器

#### 扩展现有功能
- **RegisterBody.java**: 扩展注册对象，增加姓名、性别等字段
- **TransactionsMapper.java/xml**: 新增按成员过滤的统计查询方法
- **IStatisticsService.java**: 增加支持成员过滤的统计方法
- **StatisticsServiceImpl.java**: 实现新的统计方法

### 3. 控制器层权限控制

#### TransactionsController.java 修改
- **查询权限**: 管理员可查看家庭所有记录，普通成员只能查看自己的记录
- **新增权限**: 所有成员都可以添加，但只能添加到自己名下
- **修改权限**: 管理员可修改所有记录，普通成员只能修改自己的记录
- **删除权限**: 管理员可删除所有记录，普通成员只能删除自己的记录
- **导出权限**: 按角色过滤导出数据范围

#### StatisticsController.java 修改
- **统计概览**: 管理员看全家数据，普通成员看个人数据
- **分类统计**: 收入/支出分类按角色过滤数据范围
- **趋势分析**: 月度收支趋势按角色显示不同数据

#### 新增 FamilyRegisterController.java
- **注册管理**: 家庭管理员可以查看、审批、拒绝注册申请
- **状态查询**: 提供注册状态查询接口

### 4. 注册流程修改

#### SysRegisterService.java 修改
- 将原有的直接创建用户改为创建注册申请记录
- 用户注册后需等待家庭管理员审批
- 审批通过后才会创建家庭和成员记录

## 核心权限控制逻辑

### 数据权限过滤
```java
// 普通成员只能操作自己的数据
if (!isCurrentUserFamilyAdmin()) {
    Integer currentMemberId = getCurrentUserMemberId();
    if (currentMemberId == null || !currentMemberId.equals(record.getMemberId())) {
        return error("普通成员只能操作自己的记录");
    }
}
```

### 统计数据过滤
```java
// 根据用户角色决定统计范围
Integer memberId = null;
if (!isCurrentUserFamilyAdmin()) {
    memberId = currentMember.getId(); // 普通成员只看自己的数据
}
```

## 权限矩阵

| 功能 | 家庭管理员 | 普通成员 |
|------|-----------|----------|
| 查看交易记录 | 全家庭 | 仅个人 |
| 新增交易记录 | ✓ | ✓ |
| 修改交易记录 | 全家庭 | 仅个人 |
| 删除交易记录 | 全家庭 | 仅个人 |
| 统计分析 | 全家庭 | 仅个人 |
| 审批注册 | ✓ | ✗ |
| 家庭成员管理 | ✓ | ✗ |

## 使用说明

### 注册流程
1. 用户填写注册信息（包含角色选择）
2. 系统将注册信息保存到 `family_register` 表，状态为"待审批"
3. 家庭管理员登录后可在注册管理页面查看待审批申请
4. 管理员可以选择通过或拒绝申请
5. 申请通过后，系统自动创建家庭（如果是管理员）和成员记录
6. 用户可使用原账号密码登录系统

### 权限说明
- **家庭管理员**: 拥有完整的家庭数据管理权限
- **普通成员**: 只能管理自己的收支记录，查看自己的统计数据
- 所有统计图表（饼图、折线图）都会根据用户角色自动过滤数据

## 注意事项

1. 现有的权限检查机制 `FamilyPermissionService` 继续使用
2. 所有数据库查询都增加了家庭ID和成员ID的双重过滤
3. 前端需要根据用户角色调整界面显示（如隐藏管理功能按钮）
4. 建议在前端实现用户角色状态的缓存机制
